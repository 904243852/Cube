<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"><!-- 网页的宽度自动适应手机屏幕的宽度 -->
    <title>Cube</title>
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.css">
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html, body {
            width: 100%;
            height: 100%;
        }
        html {
            overflow: hidden;
        }
        #container {
            width: 100%;
            height: 100%;
        }
        #btn {
            position: fixed; bottom: 40px; right: 40px; /* 固定定位在屏幕右下角 */
            z-index: 10; /* 置顶显示 */
            width: 40px; height: 40px; /* 固定大小为 40x40 */
            display: flex;
            line-height: 40px;
            justify-content: center;
            background-color: white;
            border-radius: 50%;
            cursor: pointer;
            transition-duration: .3s;
            box-shadow: 0 0 8px 0 rgb(255, 255, 255, 0.82);
            -webkit-tap-highlight-color: transparent; /* 去除移动端点击后出现的阴影 */
        }
        #btn:active {
            box-shadow: 0 0;
            transform: scale(0.95);
        }
        #btn svg {
            width: 24px;
        }
    </style>
</head>

<body>
    <div id="container"></div>
    <div id="btn">
        <svg style="display: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><path d="M336 112a80 80 0 0 0-160 0v96" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><rect x="96" y="208" width="320" height="272" rx="48" ry="48" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></rect></svg>
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M416 128L192 384l-96-96"></path></svg>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/typescript/5.2.2/typescript.min.js"></script>

    <script src="https://cdn.bootcdn.net/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>

    <script>var require = { paths: { "vs": "https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.45.0/min/vs" } }</script>
    <script src="https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.nls.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.js"></script>

    <script>
        ({
            // 示例模板代码
            examples: {
                controller: `export default function (ctx: ServiceContext): ServiceResponse | Uint8Array | any {\n    return "hello, world"\n}`,
                typescript: `export default function () {\n    \n}`,
                html: `<!DOCTYPE html>\n<html>\n\n<head>\n    <meta charset="utf-8" />\n    <title></title>\n</head>\n\n<body>\n    hello, {{ .name }}\n</body>\n\n</html>`,
                vue: `<template>\n    <p>hello, {{ name }}</p>\n</template>\n\n\x3Cscript>\n    module.exports = {\n        data: function() {\n            return {\n                name: "world"\n            }\n        }\n    }\n\x3C/script>\n\n<style scoped>\n\n</style>`,
            },

            // 页面模型对象，用于双向绑定
            vdata: (function (data) {
                const funcs = {}
                return new Proxy({
                    ...data,
                    $bind(property, func) { // 绑定属性的渲染方法，当对应属性被赋值时触发
                        func.call(data, data[property]) // 初始化渲染一次
                        funcs[property] = func
                    },
                }, {
                    get: function(target, property) {
                        return target[property]
                    },
                    set: function(target, property, value) {
                        if (funcs[property]) {
                            funcs[property].call(target, value)
                        }
                        target[property] = value
                    },
                })
            })({
                status: "writable", // 源码状态，readonly=只读、writable=可写
                loaded: false, // 源码是否已加载
            }),

            // 请求入参
            input: (function () {
                // 获取 URL 查询参数
                const params = new URL(window.location).searchParams,
                    name = params.get("name"),
                    type = params.get("type"),
                    example = params.has("example")

                // 获取代码坐标锚点
                const groups = window.location.hash.substring(1).match(/(?<startLineNumber>\d*),(?<startColumn>\d*)-(?<endLineNumber>\d*),(?<endColumn>\d*)/)?.groups,
                    selection = {
                        ...(groups?.startLineNumber && {
                            startLineNumber: Number(groups.startLineNumber),
                            startColumn: Number(groups.startColumn) || 0,
                        }),
                        ...(groups?.endLineNumber && {
                            endLineNumber: Number(groups.endLineNumber),
                            endColumn: Number(groups.endColumn) || 0,
                        }),
                    }

                return { name, type, selection, example, }
            })(),

            // 渲染 Monaco Editor
            render(lang) {
                // 初始化 Editor 的 typescript 编译选项
                monaco.languages.typescript.typescriptDefaults.setCompilerOptions({
                    allowNonTsExtensions: true,
                    experimentalDecorators: true, // 启用实验性的装饰器特性
                    typeRoots: ["."],
                    downlevelIteration: true, // 允许迭代器进行迭代
                    target: monaco.languages.typescript.ScriptTarget.ES2017, // 启用 ES2017 版本，可兼容 String 的 padStart、padEnd 方法
                    moduleResolution: ts.ModuleResolutionKind.NodeJs, // 指定使用 nodejs 模块解析策略，否则在 import node_modules/* 时无法解析模块
                })

                // 如果当前语言是 typescript，需要提前加载定义文件和模块文件
                if (lang === "typescript") {
                    // 预加载 global.d.ts
                    fetch("global.d.ts", {
                        method: "GET",
                    }).then(r => r.text()).then(r => {
                        monaco.languages.typescript.typescriptDefaults.addExtraLib(r, "global.d.ts")
                    })

                    // 预加载所有 module source，用于 import
                    fetch("source?type=module&size=100", {
                        method: "GET",
                    }).then(r => r.json()).then(r => {
                        (r.data.sources || []).forEach(s => {
                            monaco.languages.typescript.typescriptDefaults.addExtraLib(s.content, s.name + ".ts")
                        })
                    })
                }

                // 创建 Editor
                const editor = monaco.editor.create(document.querySelector("#container"), {
                    language: lang,
                    theme: "vs-dark",
                    model: monaco.editor.createModel(this.examples[this.input.type] || this.examples[lang] || "", lang, new monaco.Uri("noname")),
                    options: {
                        selectOnLineNumbers: true,
                        roundedSelection: false,
                        readOnly: false,
                        cursorStyle: "line",
                        automaticLayout: true,
                    },
                })

                // 重写 editorService 的 openEditor 方法，实现代码的跳转定义
                const that = this
                editor._codeEditorService.doOpenEditor = function (editor, input) {
                    const model = this.findModel(editor, input.resource),
                        selection = input.options.selection
                    if (model) {
                        editor.setModel(model)
                        that.setEditorFocus(editor, selection)
                        return
                    }
                    const matches = input.resource.path.match(/^(?:\/(node_modules\/\w+)|\.\/(\w+))\.ts$/),
                        name = matches?.[1] || matches?.[2]
                    if (name) {
                        window.open(`/editor.html?name=${name}&type=module#${selection.startLineNumber},${selection.startColumn}-${selection.endLineNumber},${selection.endColumn}`)
                    }
                }

                // 注册事件以及按键命令
                editor.onDidFocusEditorText(() => {
                    if (that.vdata.status === "readonly") {
                        document.activeElement.blur() // 防止在只读模式下，移动端点击编辑框时弹出软键盘
                    }
                })

                // 注册全局 resize 事件，当浏览器窗口大小发生改变时，编辑器自动调整大小
                window.onresize = () => editor.layout()

                // 注册 Editor 快捷键
                this.setEditorShortcutKeys(editor, this.input)

                // 注册保存按钮的点击事件
                this.setBtnClick(editor)

                return editor
            },

            // 设置 Editor 的光标位置
            setEditorFocus(editor, selection) {
                if (!selection || !Object.keys(selection).length) {
                    return
                }
                if (typeof selection.endLineNumber === "number" && typeof selection.endColumn === "number") {
                    editor.setSelection(selection)
                    editor.revealRangeInCenter(selection, 1)
                } else {
                    const position = {
                        lineNumber: selection.startLineNumber,
                        column: selection.startColumn,
                    }
                    editor.setPosition(position)
                    editor.revealPositionInCenter(position, 1)
                }
                editor.focus()
            },

            // 注册 Editor 快捷键
            setEditorShortcutKeys(editor, input) {
                const that = this
                document.onkeydown = function (e) {
                    const keyCode = e.keyCode || e.which || e.charCode,
                        ctrlKey = e.ctrlKey || e.metaKey
                    if (ctrlKey && keyCode === 83) { // Ctrl + S
                        if (!that.vdata.loaded) { // 如果没有加载完禁止保存提交，防止被覆盖
                            that.alert("Source has not been loaded yet", "error")
                            return
                        }

                        const src = editor.getValue(),
                            jsSrc = editor.getModel().getLanguageId() !== "typescript" ? "" : ts.transpileModule(src, {
                                compilerOptions: {
                                    module: ts.ModuleKind.CommonJS,
                                    inlineSourceMap: true, // 使源映射文件（即 *.js.map 文件）在生成的 js 文件中内联写入：源映射内容会以 `//#soureMappingURL=` 开头，按 base64 格式追加写入
                                    inlineSources: true, // 指定进一步将 ts 文件的内容也包含到输出文件中
                                    removeComments: true, // 移除注释
                                    downlevelIteration: true, // 当 target 为 ES5 或 ES3 时，为 for-of、spread 和 destructuring 中的迭代器提供完全支持
                                    target: ts.ScriptTarget.ES2015, // 指定编译后的 ECMAScript 代码语法版本
                                },
                                fileName: `${input.name || "noname"}.ts`,
                            })?.outputText

                        const onSourceSaving = function (name) {
                            fetch("source", {
                                method: "PUT",
                                body: JSON.stringify({ name, type: input.type, content: src, compiled: jsSrc, }),
                            }).then(r => r.json()).then(r => {
                                if (r.code === "0") {
                                    that.alert("Saved successfully", "success")
                                    input.name = name
                                } else {
                                    that.alert(r.message, "error")
                                }
                            })
                        }
                        if (!input.name) {
                            swal({ text: "Please input name:", content: "input", button: { text: "Create", closeModal: false } }).then(name => {
                                if (!name) {
                                    that.alert("name is required", "error")
                                    return
                                }
                                onSourceSaving(name)
                            })
                        } else {
                            onSourceSaving(input.name)
                        }
                        return false
                    }
                }
            },

            // 注册保存按钮的图标状态和点击事件
            setBtnClick(editor) {
                const that = this,
                    b = document.querySelector("#btn"),
                    [u, s] = b.children
                // 绑定 vdata 属性 status 到按钮状态图标的绑定
                that.vdata.$bind("status", function (value) {
                    [u.style.display, s.style.display] = ["", "none"].sort((a, b) => a.localeCompare(b) - 1 - (value !== "readonly"))
                })
                // 注册按钮点击事件
                b.onclick = function () {
                    if (that.vdata.status === "readonly") { // 已锁定
                        // 解锁
                        that.vdata.status = "writable"
                        editor.updateOptions({ readOnly: false, })
                        return
                    }
                    document.onkeydown({ ctrlKey: true, keyCode: 83, }) // 触发保存事件
                }
            },

            // 弹框提示
            alert(message, level = "warning") {
                swal(message, "", level)
                if (level === "error") { // 如果是 error 则抛出异常并停止当前程序运行
                    throw message
                }
            },

            // 初始化
            async mount() {
                if (!this.input.name) {
                    this.alert("name is required")
                    return
                }

                // 根据 name 和 type 查询 source
                const source = (await fetch(`source?name=${this.input.name}&type=${this.input.type}`, {
                    method: "GET",
                }).then(r => r.json()).then(r => r.data.sources) || []).pop()
                if (!source) {
                    this.alert(`${this.input.type} "${this.input.name}" does not existed`)
                    return
                }

                const lang = { vue: "html" }[source.lang] || source.lang,
                    editor = this.render(lang)
                if (!!source.content || !this.input.example) {
                    editor.setValue(source.content || "")
                    this.setEditorFocus(editor, this.input.selection) // 光标跳转至指定代码位置
                    this.vdata.status = "readonly"
                    editor.updateOptions({ readOnly: true, })
                }
                this.vdata.loaded = true
            },
        }).mount()
    </script>
</body>

</html>